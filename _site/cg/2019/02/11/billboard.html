<!doctype html>
<html lang="zh">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="msvalidate.01" content="D1B532AF972A1AB6C3525C904A9AC816" />
  <meta name="google-site-verification" content="-ujy_zWUIaX-QJ4vdUYfXThyZgr_KqsU0lL611rqsy8" />
  <title>OpenGL 中的广告牌</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/app.js"></script>
</head>

  <body>
    <div id="contentPane" class="huge-page real main">
      <h1><a href="/">Frame of 42yeah</a></h1>
      <h2>OpenGL 中的广告牌</h2>
      <hr />
      <section>
        <div style="margin-bottom: -25px">
  <div id='MicrosoftTranslatorWidget' class='Dark' style='color:white;background-color:inherit;height:30px;'></div>
</div>

<script type='text/javascript'>
  setTimeout(function(){
    {var s=document.createElement('script');s.type='text/javascript';s.charset='UTF-8';s.src=((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?siteData=ueOIGRSKkd965FeEGM5JtQ**&ctf=False&ui=true&settings=Manual&from=';var p=document.getElementsByTagName('head')[0]||document.documentElement;p.insertBefore(s,p.firstChild); }
  },0);
</script>
<script type='text/javascript' src='//www.bing.com/widget/bootstrap.js' data-id='cc2030a35e7345a1940e909993402b13' data-version='1.0b' data-autosnapshot='false' async></script>
        <p>搞图形学搞到某一个阶段，你就会开始用到模型。但是，当你太特么的懒了，根本不想学建模，但是又想做好玩的东西的时候咋办捏？</p>

<p>这时候就轮到 <a href="http://www.opengl-tutorial.org/intermediate-tutorials/billboards-particles/billboards/">广告牌</a> 来搭救了！好好看看，你有没有兴趣实现以下的效果：</p>

<p><img src="/assets/southpine.png" alt="性感广告牌" /></p>

<p>完全不需要建模，一样能搞到跟真的一样。</p>

<h2 id="废话少说马上开波">废话少说，马上开波！</h2>

<p>实则来说，广告牌不是很难；但是我搜了一下，发现实现广告牌的方法有非常多种，并不限制于一种。我在试的头崩额裂之后，终于试出了一些简单易懂外加可行的方法了！</p>

<h2 id="难的">难的</h2>

<p><em>以下参考 <a href="http://www.opengl-tutorial.org/intermediate-tutorials/billboards-particles/billboards/">opengl-tutorial</a>。</em></p>

<p>我们直接用那里的 “The 3D Way” :</p>

<p><img src="/assets/spin.gif" alt="旋转的带血条的立方体" /></p>

<p>实际上，实现这个的方法不难，虽然我没懂。我真的挺想懂的，可能我老了……有人可以明了一点儿的跟我说说嘛……感激不尽……</p>

<p>按照他的方法，他是这样说的：</p>

<blockquote>
  <p>你可以把这个问题当作生成一个 model 矩阵，虽然事实上比这个简单多了。咱们这里的主要主意是广告牌的每个角落都位于中心位置，他们都被摄像机的<strong>上向量</strong>和<strong>右向量</strong>移位了:</p>
</blockquote>

<p><img src="/assets/billboard1.png" alt="他的方法，我没看懂他怎么移的" /></p>

<blockquote>
  <p>问题在于，我们只知道广告牌的世界坐标，所以很明显我们需要相机的上/右向量的世界坐标。</p>
</blockquote>

<blockquote>
  <p>在相机坐标内，相机的上向量是 <code class="highlighter-rouge">(0, 1, 0)</code> 。要进入到世界空间里头的话，只要把这个乘以那个把相机空间转换为世界空间的矩阵就行了。通俗点儿来说，就是 view 矩阵的逆。</p>
</blockquote>

<blockquote>
  <p>这情况下可以直接写成这样：</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CameraRight_worldspace</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewMatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ViewMatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ViewMatrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span>
<span class="n">CameraUp_worldspace</span> <span class="o">=</span> <span class="p">{</span><span class="n">ViewMatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ViewMatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ViewMatrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span>
</code></pre></div></div>

<blockquote>
  <p>一旦我们有这个了，那么算上最后顶点的位置就好办了：</p>
</blockquote>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">vec3</span> <span class="n">vertexPosition_worldspace</span> <span class="o">=</span>
    <span class="n">particleCenter_worldspace</span>
    <span class="o">+</span> <span class="n">CameraRight_worldspace</span> <span class="o">*</span> <span class="n">squareVertices</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">BillboardSize</span><span class="p">.</span><span class="n">x</span>
    <span class="o">+</span> <span class="n">CameraUp_worldspace</span> <span class="o">*</span> <span class="n">squareVertices</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">BillboardSize</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>particleCenter_worldspace 就是广告牌的中点位置。他应该是一个 <code class="highlighter-rouge">uniform vec3</code> 。</li>
  <li>CameraRight_worldspace 就是相机的右向量。</li>
  <li>squareVertices 就是网格坐标。</li>
  <li>BillboardSize 就是在你世界单位里面的广告牌的大小，譬如 <code class="highlighter-rouge">vec2(2.0, 1.0)</code> 。当然咯，是多大的话是你自己说了算的。</li>
</ul>

<p>我们拿到这个之后最后的 <code class="highlighter-rouge">gl_Position</code> 就是:</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">gl_Position</span> <span class="o">=</span> <span class="n">perspec</span> <span class="o">*</span> <span class="n">view</span> <span class="o">*</span> <span class="n">vertexPosition_worldspace</span><span class="p">;</span> 
</code></pre></div></div>

<p>这样就有我们想要的广告牌了。简单不？(我：不简单……)</p>

<p><img src="/assets/pinch.gif" alt="效果图" /></p>

<h2 id="缺点">缺点</h2>

<p>为啥我把这个管叫做难的呢？这是因为我没懂他里面的意思……虽然我连下面我即将说的简单的的意思也没懂，但起码比这个难的的容易理解一点点……</p>

<p>并且，这个有他的缺点。就是如果你只想要顺着 x 轴旋转的话，咋办？譬如说，你想画一堆的树。当你在飞起来的时候，这些树不应该看起来像倒了一样吧：</p>

<p><img src="/assets/billboard_trees.jpg" alt="立着的树" /></p>

<p>要是我飞高了，这些树为了向着摄像头，全部都跟倒了一样……那我要这广告牌干哈？</p>

<p>在这里，opengl-tutorial 是 <strong>这样</strong> 解释的:</p>

<hr />

<h2 id="solution-4--vertical-rotation-only">Solution #4 : Vertical rotation only</h2>

<p>Some systems model faraway trees and lamps as billboards. But you really, really don’t want your tree to be bent : it MUST be vertical. So you need an hybrid system that rotates only around one axis.</p>

<p>Well, this one <strong>is left as an exercise to the reader !</strong></p>

<hr />

<p>WTF? An exercise? 我连上面的都没懂……</p>

<p>因此，为了解决这个问题，我上网搜了各种关键词，终于找到了……</p>

<h2 id="简单的方法">简单的方法！</h2>

<p><em>以下参考 <a href="http://www.lighthouse3d.com/opengl/billboarding/billboardingtut.pdf">lighthouse3d</a>。</em></p>

<p>首先我们通过他的截图和源码，可以知道这是一个<strong>很老</strong>的教程，但无论如何，这个比别的容易懂很多:</p>

<p><img src="/assets/snowman.png" alt="雪人" /></p>

<p>但无论如何，马上开波！</p>

<p>首先，回想一下我们的 MVP 矩阵。通常的时候，我们是这样变换我们的坐标的：</p>

<div class="language-glsl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">gl_Position</span> <span class="o">=</span> <span class="n">perspec</span> <span class="o">*</span> <span class="n">view</span> <span class="o">*</span> <span class="n">model</span> <span class="o">*</span> <span class="kt">vec4</span><span class="p">(</span><span class="n">aPos</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>其中，perspec<sub>tive</sub> 只是透视罢了；也就是说，所有的坐标变换实际上都在 <code class="highlighter-rouge">view * model</code> 处早已处理完毕，包括移位，旋转，放大，缩小，哔哩吧啦。因此，我们好好看看这个矩阵：</p>

<p><img src="/assets/billboard2.png" alt="矩阵" /></p>

<p>红框的三行就是现在相对于相机的位置和朝向了。而 3x3 的篮框子矩阵上则是缩放和旋转等操作。于是，我们只要把篮框变成一个单位向量，就能 <strong>非常有效</strong> 的把缩放和旋转之类的完全逆掉了，等于渲染出来的东西将会永远朝向咱们：</p>

<p><img src="/assets/brilliant.png" alt="牛逼" /></p>

<p>也就是说，我们只要把 view * model 计算出来，然后:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">row</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">modelView</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span> <span class="o">==</span> <span class="n">col</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>就能达到和刚刚困难的那个的一样的广告牌效果了。</p>

<h2 id="那树咋办">那树咋办？</h2>

<p>我们回到这个矩阵。</p>

<p><img src="/assets/billboard2.png" alt="矩阵" /></p>

<p>实际上，蓝色框框内的每一列都是有他的特殊含义的。实际上:</p>
<ul>
  <li>第一列记录的是右向量。</li>
  <li>第二列记录的是上向量。（我好像懂了难的那里为啥要这样提取了）</li>
  <li>第三列记录的是要看向啥地方。（也就是 <code class="highlighter-rouge">lookAt</code> 向量）</li>
</ul>

<p>于是乎，我们只要保留上向量不变的，其他列都按单位矩阵的形式来改的话，东西渲染出来的时候因为没有旋转，所以当然还是朝向摄像头；但是当向上/下看的时候，广告牌就不会动了。也就是说，现在广告牌只会在玩家朝左/右看的时候才会旋转了:</p>

<p><img src="/assets/BRILLIAANT.png" alt="真的牛逼，卧槽" /></p>

<p>而这就是结果了！</p>

<p><img src="/assets/billboard3.png" alt="Southpine!" /></p>

<p>全文完！</p>

<h2 id="或者还没完">或者还没完？</h2>

<p>当然，实际上，我刚刚说的并不是真的广告牌；按照 <a href="http://www.lighthouse3d.com/">lighthouse3d</a> 的说法，这些方法充其量只是 “作弊”。</p>

<p>为啥呢？因为，广告牌是要在任何时候都 <strong>朝向</strong> 你，才叫做广告牌。这里有一个很鲜明的，并不是朝向你的例子：</p>

<p><img src="/assets/cheating.png" alt="作弊!" /></p>

<p>如果是广告牌，根据他们应该 <strong>朝向你</strong> 的规定，因为这里的人他们的位置不一样，他们如果都要朝向你的话，他们的方向很明显不应该一致。</p>

<p>因此，以上所说的所有方法都只能算是作弊。</p>

<p>但没关系，<a href="http://www.lighthouse3d.com/opengl/billboarding/billboardingtut.pdf">这里</a> 给出来的解决方案着实完美，但由于时间关系以及我的 “我都已经大概实现这个功能了随便啦” 的想法，我就没往后看了。有兴趣的可以自个儿去看。祝你好运！</p>

      </section>
      <h2 id="评论区">评论区</h2>
<div id="disqus_thread" style="font-size: 12px !important;"></div>
<script>
  var disqus_config = function () {
    this.page.url = "https://potion4.github.io/cg/2019/02/11/billboard.html";
    this.page.identifier = "OpenGL 中的广告牌";
  };

  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://frame-of-42yeah.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  </body>
</html>
