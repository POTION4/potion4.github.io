<!doctype html>
<html lang="zh">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="msvalidate.01" content="D1B532AF972A1AB6C3525C904A9AC816" />
  <meta name="google-site-verification" content="-ujy_zWUIaX-QJ4vdUYfXThyZgr_KqsU0lL611rqsy8" />
  <title>WebAssembly 反着用回 Javascript</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/app.js"></script>
</head>

  <body>
    <div id="contentPane" class="huge-page real main">
      <h1><a href="/">Frame of 42yeah</a></h1>
      <h2>WebAssembly 反着用回 Javascript</h2>
      <hr />
      <section>
        <div style="margin-bottom: -25px">
  <div id='MicrosoftTranslatorWidget' class='Dark' style='color:white;background-color:inherit;height:30px;'></div>
</div>

<script type='text/javascript'>
  setTimeout(function(){
    {var s=document.createElement('script');s.type='text/javascript';s.charset='UTF-8';s.src=((location && location.href && location.href.indexOf('https') == 0)?'https://ssl.microsofttranslator.com':'http://www.microsofttranslator.com')+'/ajax/v3/WidgetV3.ashx?siteData=ueOIGRSKkd965FeEGM5JtQ**&ctf=False&ui=true&settings=Manual&from=';var p=document.getElementsByTagName('head')[0]||document.documentElement;p.insertBefore(s,p.firstChild); }
  },0);
</script>
<script type='text/javascript' src='//www.bing.com/widget/bootstrap.js' data-id='cc2030a35e7345a1940e909993402b13' data-version='1.0b' data-autosnapshot='false' async></script>
        <p>前两天我们讲了一下各种 Wasm 的基本操作，以及 Javascript 中怎么样方便的调用 wasm 中存在的函数。那么你有没有想过，在 C/C++ 中有没有可能可以调用 Javascript 呢？答案是可以的，而且方法有很多种：</p>

<h2 id="em_js"><code class="highlighter-rouge">EM_JS</code></h2>
<p>直接在 C/C++ 的源码中加入 <code class="highlighter-rouge">EM_JS</code> 可以在 C/C++ 中直接申明一个用 Javascript 写的函数：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EM_JS</span><span class="p">(</span><span class="kt">void</span><span class="p">,</span> <span class="n">alerts</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span>
    <span class="n">alert</span><span class="p">(</span><span class="s">"hai"</span><span class="p">)</span>
    <span class="n">alert</span><span class="p">(</span><span class="s">"bai"</span><span class="p">)</span>
<span class="p">});</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">alerts</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>很明显可以看出来，上例中 <code class="highlighter-rouge">EM_JS</code> 就是在申明一个 Javascript 的函数：<code class="highlighter-rouge">function alerts() { ... }</code> 。其中第一个参数是返回值，第二个参数是函数名，第三个参数是参数列表，第四个参数就是用 Javascript 写的函数的实现部分了。这样一来，在 C/C++ 中调用 Javascript 里的东西可谓是超级方便，可以当作是一个外部库之类的。</p>

<p>你还可以参考多一个例子：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">EM_JS</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="p">});</span>
</code></pre></div></div>

<p>这个很明显就是求和了。</p>

<h2 id="em_asm"><code class="highlighter-rouge">EM_ASM</code></h2>
<p>有的时候，可能因为心态炸了，或者是贼懒，你压根就不想声明一个函数然后再调用他。这么烦干嘛呢？很幸运，我们还有 <code class="highlighter-rouge">EM_ASM</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"hello world in C/C++!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">EM_ASM</span><span class="p">({</span>
        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">UTF8ToString</span><span class="p">(</span><span class="err">$</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">},</span> <span class="s">"hello world in javascript and the argument is even passed from C/C++!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>不难看出，<code class="highlighter-rouge">EM_ASM</code> 在写完要执行的那段代码之后，后面是可以跟无限个参数的。而执行的那一段是可以看到这些参数的，从 $0 开始，然后是 $1, $2, … 自己用类比推理法吧。。。</p>

<p>总而言之，<code class="highlighter-rouge">EM_ASM</code> 可以通过这种方式来达成 C/C++/Javascript <del>滥交</del>混交。通过这些方法，你既可以有的时候 C/C++，也可以有的时候 Javascript ，也可以在 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 中调用 C 中调用 Javascript 了！！！</p>

<h2 id="emscripten_run_script"><code class="highlighter-rouge">emscripten_run_script</code></h2>
<p>忘记了还有一种方法了。。。就是这个，<code class="highlighter-rouge">emscripten_run_script</code>。这个几乎是一个完全本土化的 C 函数了，他接受的参数是一个 char * 。也就是说你可以这样用：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">emscripten_run_script</span><span class="p">(</span><span class="s">"console.log('hello world')"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>通过这种方式，可以动态的执行 javascript 代码，因为是直接调用 js 中的 eval() 方法的。但是注意，如果你编译的时候增加了参数 <code class="highlighter-rouge">-s DYNAMIC_EXECUTION=0</code> ，那么这个函数将会不可用🚫🙅🈲️。（话说不可用的 emoji 可真多。。。）</p>

<h1 id="提起兴趣">提起兴趣！！！</h1>
<p>经过了连续三天的 Wasm 日志！我决定用我自己写的一些小东西来提起一下大家的兴趣（里面核心功能都由 C/C++ 实现！）。。</p>

<h2 id="斐波拉契数列">斐波拉契数列</h2>
<p><a href="javascript:oneMore()">算多一个</a></p>
<p id="fibonacci"></p>

<h2 id="旋转的方块">旋转的方块</h2>
<div id="picture" style="width: 100px; height: 100px; background-color: orange; margin-left: 1em;">
    &nbsp;
</div>

<h2 id="字符串--二进制码">字符串 =&gt; 二进制码</h2>
<p><input id="input" />
<a href="javascript:accepted()">转换</a></p>
<p id="output"></p>

<hr />
<p>你随时可以进入检索来看看我实现的方法。</p>

<h1 id="玩得开心"><em>玩得开心！</em></h1>

<script>
    let picture = document.getElementById("picture")
    let output = document.getElementById("output")
    let fibonacci = document.getElementById("fibonacci")
    let input = document.getElementById("input")
    let frame, binarify, fib;

    function onRuntimeInitialized() {
        function animation() {
            requestAnimationFrame(animation)
            frame()
        }
        animation()
    }


    function oneMore() {
        fibonacci.innerHTML = fib()
    }


    function accepted() {
        binarify(input.value)
    }


    var Module = {
        print: function(text) {
            output.innerHTML += "<br />" + text
        },

        onRuntimeInitialized: function() {
            frame = Module.cwrap("frame", "void", [])
            binarify = Module.cwrap("binarify", "void", [ "string" ])
            fib = Module.cwrap("fib", "string", [])

            onRuntimeInitialized()
        },
    }
</script>

<script src="/assets/jff.js"></script>


      </section>
      <h2 id="评论区">评论区</h2>
<div id="disqus_thread" style="font-size: 12px !important;"></div>
<script>
  var disqus_config = function () {
    this.page.url = "https://potion4.github.io/webassembly/2019/01/09/wasm-backfire.html";
    this.page.identifier = "WebAssembly 反着用回 Javascript";
  };

  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://frame-of-42yeah.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  </body>
</html>
